name: IAASSE Jobs Fetcher

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y php php-cli php-xml

      # ✅ Ensure Node.js for JSON validation
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # ✅ Run fetcher (fail on error)
      - name: Run jobs fetcher
        run: |
          set -e
          php fetch-jobs.php

      # ✅ JSON SCHEMA VALIDATION (KEEP THIS)
      - name: Validate jobs-data.json
        run: |
          node -e "
          const fs = require('fs');

          if (!fs.existsSync('jobs-data.json')) {
            console.error('❌ jobs-data.json not found');
            process.exit(1);
          }

          const data = JSON.parse(fs.readFileSync('jobs-data.json','utf8'));

          if (!Array.isArray(data.jobs)) {
            console.error('❌ jobs must be an array');
            process.exit(1);
          }

          data.jobs.forEach((job,i)=>{
            const required = ['title','company','country','employment','link','date'];
            required.forEach(k=>{
              if(!job[k]){
                console.error(`❌ Missing ${k} at job index ${i}`);
                process.exit(1);
              }
            });

            if (typeof job.date !== 'number') {
              console.error(`❌ Invalid date at job index ${i}`);
              process.exit(1);
            }
          });

          console.log('✅ jobs-data.json validation passed');
          "

      - name: Commit jobs JSON
        run: |
          git config user.name "IAASSE Bot"
          git config user.email "bot@iaasse.org"
          git add jobs-data.json
          git commit -m "Update jobs data" || exit 0
          git push
